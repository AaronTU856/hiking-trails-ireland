{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trails Map - Proximity Search</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
      #map { height: calc(100vh - 56px); }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-success">
  <div class="container">
    <a class="navbar-brand" href="#">ğŸ¥¾ Irish Trails Map</a>
  </div>
</nav>

<div id="map"></div>

<div class="position-absolute top-0 end-0 p-3" style="z-index:1000;">
  <div class="card p-2">
    <h6>ğŸ” Trails within radius</h6>
    <input id="radius-input" type="number" class="form-control form-control-sm mb-2" value="50" min="1" max="500" />
    <button id="toggle-search" class="btn btn-success btn-sm w-100">Enable Search</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([53.35, -6.26], 7);

  // Basemap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  let searchEnabled = false;
  let searchMarker = null;
  let radiusCircle = null;
  let trailMarkers = [];

  document.getElementById('toggle-search').addEventListener('click', () => {
    searchEnabled = !searchEnabled;
    const btn = document.getElementById('toggle-search');
    if (searchEnabled) {
      btn.textContent = 'Click on map to search';
      btn.className = 'btn btn-danger btn-sm w-100';
    } else {
      btn.textContent = 'Enable Search';
      btn.className = 'btn btn-success btn-sm w-100';
      clearSearch();
    }
  });

  map.on('click', async (e) => {
    if (!searchEnabled) return;

    const radius = parseFloat(document.getElementById('radius-input').value) || 50;
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    clearSearch();

    searchMarker = L.marker([lat, lng]).addTo(map).bindPopup('Search center').openPopup();
    radiusCircle = L.circle([lat, lng], {radius: radius * 1000, color: 'green', fillOpacity: 0.1}).addTo(map);

    const res = await fetch('/api/trails/within-radius/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ latitude: lat, longitude: lng, radius_km: radius })
    });

    if (!res.ok) {
      alert('Error fetching trails');
      return;
    }

    const data = await res.json();
    data.trails.forEach((trail, i) => {
      const [lng, lat] = trail.start_point.coordinates;
      const marker = L.marker([lat, lng])
        .addTo(map)
        .bindPopup(`<b>${trail.trail_name}</b><br>County: ${trail.county}<br>Distance: ${trail.distance_km} km`);
      trailMarkers.push(marker);
    });

    if (trailMarkers.length) {
      const group = L.featureGroup(trailMarkers);
      map.fitBounds(group.getBounds().pad(0.2));
    }
  });

  function clearSearch() {
    if (searchMarker) map.removeLayer(searchMarker);
    if (radiusCircle) map.removeLayer(radiusCircle);
    trailMarkers.forEach(m => map.removeLayer(m));
    trailMarkers = [];
  }
</script>
</body>
</html>
