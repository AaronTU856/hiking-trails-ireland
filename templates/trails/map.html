{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trails Map - Proximity Search</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
      #map { height: calc(100vh - 56px); }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-success">
  <div class="container">
    <a class="navbar-brand" href="#">ü•æ Irish Trails Map</a>
  </div>
</nav>

<div id="map"></div>

<div id="trail-results"
     class="position-absolute bottom-0 start-0 bg-white p-2 m-3 rounded shadow"
     style="z-index:1000; width: 250px; max-height: 40vh; overflow-y: auto;">
  <small class="text-muted">Results will appear here after you click the map</small>
</div>


<div class="position-absolute top-0 end-0 p-3" style="z-index:1000;">
  <div class="card p-2">
    <h6>üîç Trails within radius</h6>
    <input id="radius-input" type="number" class="form-control form-control-sm mb-2" value="50" min="1" max="500" />
    <button id="toggle-search" class="btn btn-success btn-sm w-100">Enable Search</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([53.35, -6.26], 7);

  // Basemap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);



 // Function to load and display trails
 async function loadTrails() {
    try {
        const response = await fetch('/api/trails/geojson/');
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

        const data = await response.json();

        if (!data.features || data.features.length === 0) {
            console.warn("‚ö†Ô∏è No trail features returned from API");
            alert("No trail data found in the database.");
            return;
        }

        const trailsLayer = L.geoJSON(data, {
            pointToLayer: (feature, latlng) => {
                return L.circleMarker(latlng, {
                    radius: 7,
                    fillColor: '#28a745',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                });
            },
            onEachFeature: (feature, layer) => {
                const props = feature.properties;
                layer.bindPopup(`
                    <div>
                        <strong>${props.trail_name}</strong><br>
                        County: ${props.county}<br>
                        Distance: ${props.distance_km} km<br>
                        Difficulty: ${props.difficulty}<br>
                        ${props.description ? `<p class="mt-1 small">${props.description}</p>` : ''}
                    </div>
                `);
            }
        }).addTo(map);

        // Fit map to markers
        const bounds = trailsLayer.getBounds();
        if (bounds.isValid()) map.fitBounds(bounds);

        console.log(`‚úÖ Loaded ${data.features.length} trails successfully`);

    } catch (error) {
        console.error('‚ùå Error loading trails:', error);
        alert('Error loading trails: ' + error.message);
    }
}

// Load trails once map is ready
loadTrails(); 



  let searchEnabled = false;
  let searchMarker = null;
  let radiusCircle = null;
  let trailMarkers = [];

  document.getElementById('toggle-search').addEventListener('click', () => {
    searchEnabled = !searchEnabled;
    const btn = document.getElementById('toggle-search');
    if (searchEnabled) {
      btn.textContent = 'Click on map to search';
      btn.className = 'btn btn-danger btn-sm w-100';
    } else {
      btn.textContent = 'Enable Search';
      btn.className = 'btn btn-success btn-sm w-100';
      clearSearch();
    }
  });

  map.on('click', async (e) => {
    if (!searchEnabled) return;

    const radius = parseFloat(document.getElementById('radius-input').value) || 50;
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    clearSearch();

    searchMarker = L.marker([lat, lng]).addTo(map).bindPopup('Search center').openPopup();
    radiusCircle = L.circle([lat, lng], {radius: radius * 1000, color: 'green', fillOpacity: 0.1}).addTo(map);

    const res = await fetch('/api/trails/within-radius/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ latitude: lat, longitude: lng, radius_km: radius })
    });

    if (!res.ok) {
      alert('Error fetching trails');
      return;
    }

    const data = await res.json();

     // Clear old list and repopulate
     const resultsDiv = document.getElementById('trail-results');
     resultsDiv.innerHTML = `<h6>${data.count} trail(s) found within ${radius} km:</h6>`;

      data.trails.forEach((trail, i) => {
      const [lng, lat] = trail.start_point.coordinates;
      const marker = L.marker([lat, lng])
        .addTo(map)
        .bindPopup(`<b>${trail.trail_name}</b><br>County: ${trail.county}<br>Distance: ${trail.distance_km} km`);
      trailMarkers.push(marker);
    

      // Add to sidebar list
      const item = document.createElement('div');
      item.classList.add('border', 'rounded', 'p-1', 'mb-1');
      item.innerHTML = `<b>${trail.trail_name}</b> (${trail.county}) ‚Äî ${trail.distance_km} km`;
      item.addEventListener('click', () => {
        map.setView([lat, lng], 11);
        marker.openPopup();
      });
      resultsDiv.appendChild(item);
    });


    if (trailMarkers.length) {
      const group = L.featureGroup(trailMarkers);
      map.fitBounds(group.getBounds().pad(0.2));
    }
  });

  function clearSearch() {
    if (searchMarker) map.removeLayer(searchMarker);
    if (radiusCircle) map.removeLayer(radiusCircle);
    trailMarkers.forEach(m => map.removeLayer(m));
    trailMarkers = [];
  }


</script>
</body>
</html>
