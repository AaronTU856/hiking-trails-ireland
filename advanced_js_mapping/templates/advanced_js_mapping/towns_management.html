{% extends 'base.html' %}
{% load static %}

{% block title %}Town Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f5f5;
    }
    
    .management-container {
        display: flex;
        height: calc(100vh - 60px);
        gap: 20px;
        padding: 20px;
    }
    
    .sidebar {
        width: 350px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .sidebar-header {
        padding: 20px;
        border-bottom: 2px solid #2E8B57;
        background: linear-gradient(135deg, #2E8B57 0%, #1e5c3f 100%);
        color: white;
    }
    
    .sidebar-header h2 {
        margin: 0;
        font-size: 1.5rem;
    }
    
    .search-box {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .search-box input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .search-box input:focus {
        outline: none;
        border-color: #2E8B57;
        box-shadow: 0 0 5px rgba(46, 139, 87, 0.3);
    }
    
    .filter-section {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .filter-section label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: #333;
    }
    
    .filter-section select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .towns-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }
    
    .town-item {
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }
    
    .town-item:hover {
        border-color: #2E8B57;
        background: #f0f8f4;
        box-shadow: 0 2px 6px rgba(46, 139, 87, 0.2);
    }
    
    .town-item.selected {
        border-color: #2E8B57;
        background: #e8f5e9;
        box-shadow: 0 2px 8px rgba(46, 139, 87, 0.3);
    }
    
    .town-name {
        font-weight: 600;
        margin-bottom: 4px;
        color: #333;
    }
    
    .town-info {
        font-size: 0.85rem;
        color: #666;
    }
    
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .map-container {
        flex: 1;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    #map {
        width: 100%;
        height: 100%;
    }
    
    .controls-panel {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary {
        background: #2E8B57;
        color: white;
    }
    
    .btn-primary:hover {
        background: #1e5c3f;
        box-shadow: 0 2px 8px rgba(46, 139, 87, 0.3);
    }
    
    .btn-secondary {
        background: #f0f0f0;
        color: #333;
        border: 1px solid #ddd;
    }
    
    .btn-secondary:hover {
        background: #e0e0e0;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #218838;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal.show {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #2E8B57;
    }
    
    .modal-header h2 {
        margin: 0;
        color: #333;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #999;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .close-btn:hover {
        color: #333;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.95rem;
        font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #2E8B57;
        box-shadow: 0 0 5px rgba(46, 139, 87, 0.3);
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }
    
    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 25px;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
    }
    
    .alert {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
        animation: slideIn 0.3s ease;
    }
    
    .alert-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .alert-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }
    
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #2E8B57;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    
    @media (max-width: 1024px) {
        .management-container {
            flex-direction: column;
        }
        
        .sidebar {
            width: 100%;
            height: 300px;
        }
        
        .towns-list {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px;
        }
        
        .town-item {
            flex-shrink: 0;
            width: 250px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="management-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Towns</h2>
            <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">Manage towns and cities</p>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search towns..." />
        </div>
        
        <div class="filter-section">
            <label for="countryFilter">Filter by Country</label>
            <select id="countryFilter">
                <option value="">All Countries</option>
            </select>
        </div>
        
        <div class="towns-list" id="townsList">
            <div class="empty-state">
                <i class="fas fa-map-marker-alt"></i>
                <p>No towns found</p>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Map -->
        <div class="map-container" id="mapContainer">
            <div id="map"></div>
        </div>
        
        <!-- Controls -->
        <div class="controls-panel">
            <button class="btn btn-primary" id="addTownBtn">
                <i class="fas fa-plus"></i> Add New Town
            </button>
            <button class="btn btn-secondary" id="editTownBtn" disabled>
                <i class="fas fa-edit"></i> Edit Selected
            </button>
            <button class="btn btn-danger" id="deleteTownBtn" disabled>
                <i class="fas fa-trash"></i> Delete Selected
            </button>
            <button class="btn btn-secondary" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <div style="flex: 1;"></div>
            <div id="statusMessage" style="padding: 10px; color: #666;"></div>
        </div>
    </div>
</div>

<!-- Edit Town Modal -->
<div id="editTownModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Town</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div id="editTownMessages"></div>
        <form id="editTownForm">
            <div class="form-group">
                <label for="townName">Town Name *</label>
                <input type="text" id="townName" required />
            </div>
            
            <div class="form-group">
                <label for="townCountry">Country *</label>
                <input type="text" id="townCountry" required />
            </div>
            
            <div class="form-group">
                <label for="townPopulation">Population</label>
                <input type="number" id="townPopulation" min="0" />
            </div>
            
            <div class="form-group">
                <label for="townArea">Area (km²)</label>
                <input type="number" id="townArea" step="0.01" min="0" />
            </div>
            
            <div class="form-group">
                <label for="townType">Town Type</label>
                <select id="townType">
                    <option value="">Select Type</option>
                    <option value="capital">Capital</option>
                    <option value="city">City</option>
                    <option value="town">Town</option>
                    <option value="village">Village</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="townLatitude">Latitude</label>
                <input type="number" id="townLatitude" step="0.000001" />
            </div>
            
            <div class="form-group">
                <label for="townLongitude">Longitude</label>
                <input type="number" id="townLongitude" step="0.000001" />
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2>Confirm Delete</h2>
            <button class="close-btn">&times;</button>
        </div>
        <p style="color: #666; margin-bottom: 20px;">
            Are you sure you want to delete <strong id="deleteTownName"></strong>? This action cannot be undone.
        </p>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    </div>
</div>

<!-- Add Town Modal -->
<div id="addTownModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Town</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div id="addTownMessages"></div>
        <form id="addTownForm">
            <div class="form-group">
                <label for="newTownName">Town Name *</label>
                <input type="text" id="newTownName" required />
            </div>
            
            <div class="form-group">
                <label for="newTownCountry">Country *</label>
                <input type="text" id="newTownCountry" required />
            </div>
            
            <div class="form-group">
                <label for="newTownPopulation">Population</label>
                <input type="number" id="newTownPopulation" min="0" />
            </div>
            
            <div class="form-group">
                <label for="newTownArea">Area (km²)</label>
                <input type="number" id="newTownArea" step="0.01" min="0" />
            </div>
            
            <div class="form-group">
                <label for="newTownType">Town Type</label>
                <select id="newTownType">
                    <option value="">Select Type</option>
                    <option value="capital">Capital</option>
                    <option value="city">City</option>
                    <option value="town">Town</option>
                    <option value="village">Village</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="newTownLatitude">Latitude *</label>
                <input type="number" id="newTownLatitude" step="0.000001" required />
            </div>
            
            <div class="form-group">
                <label for="newTownLongitude">Longitude *</label>
                <input type="number" id="newTownLongitude" step="0.000001" required />
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelAddBtn">Cancel</button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-plus"></i> Add Town
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
    // Initialize map
    let map;
    let markers = {};
    let selectedTownId = null;
    let towns = [];
    
    const CSRF_TOKEN = '{{ csrf_token }}';
    
    function initMap() {
        map = L.map('map').setView([53.3498, -6.2603], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);
    }
    
    function showMessage(message, type = 'info', targetId = 'statusMessage') {
        const messageEl = document.getElementById(targetId);
        if (messageEl) {
            messageEl.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                messageEl.innerHTML = '';
            }, 5000);
        }
    }
    
    function loadTowns() {
        showMessage('<span class="loading"></span> Loading towns...', 'info');
        
        fetch('{% url "advanced_js_mapping:towns_management" %}', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            }
        })
        .then(response => response.json())
        .catch(error => {
            // Fallback: load from API endpoint
            return fetch('{% url "api:town_list" %}', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                }
            });
        })
        .then(response => response.json())
        .then(data => {
            towns = data.results || data.towns || [];
            renderTownsList();
            renderMap();
            updateCountryFilter();
            showMessage(`Loaded ${towns.length} towns`, 'success');
        })
        .catch(error => {
            console.error('Error loading towns:', error);
            showMessage('Error loading towns', 'danger');
        });
    }
    
    function renderTownsList() {
        const townsList = document.getElementById('townsList');
        
        if (towns.length === 0) {
            townsList.innerHTML = '<div class="empty-state"><i class="fas fa-map-marker-alt"></i><p>No towns found</p></div>';
            return;
        }
        
        townsList.innerHTML = towns.map(town => `
            <div class="town-item ${selectedTownId === town.id ? 'selected' : ''}" data-town-id="${town.id}">
                <div class="town-name">${town.name}</div>
                <div class="town-info">
                    <div>${town.country || 'Unknown'}</div>
                    <div>Population: ${(town.population || 0).toLocaleString()}</div>
                </div>
            </div>
        `).join('');
        
        // Add click listeners
        document.querySelectorAll('.town-item').forEach(item => {
            item.addEventListener('click', () => selectTown(item.dataset.townId));
        });
    }
    
    function selectTown(townId) {
        selectedTownId = parseInt(townId);
        document.querySelectorAll('.town-item').forEach(item => {
            item.classList.toggle('selected', item.dataset.townId === townId);
        });
        
        document.getElementById('editTownBtn').disabled = false;
        document.getElementById('deleteTownBtn').disabled = false;
        
        // Center map on town
        const town = towns.find(t => t.id === selectedTownId);
        if (town && town.latitude && town.longitude) {
            map.setView([town.latitude, town.longitude], 10);
        }
    }
    
    function renderMap() {
        // Clear existing markers
        Object.values(markers).forEach(marker => marker.remove());
        markers = {};
        
        towns.forEach(town => {
            if (town.latitude && town.longitude) {
                const marker = L.marker([town.latitude, town.longitude])
                    .bindPopup(`<strong>${town.name}</strong><br>${town.country}<br>Population: ${(town.population || 0).toLocaleString()}`)
                    .addTo(map);
                
                marker.on('click', () => selectTown(town.id));
                markers[town.id] = marker;
            }
        });
    }
    
    function updateCountryFilter() {
        const countries = [...new Set(towns.map(t => t.country).filter(c => c))].sort();
        const select = document.getElementById('countryFilter');
        select.innerHTML = '<option value="">All Countries</option>' + 
            countries.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    function openEditModal(townId) {
        const town = towns.find(t => t.id === townId);
        if (!town) return;
        
        document.getElementById('townName').value = town.name || '';
        document.getElementById('townCountry').value = town.country || '';
        document.getElementById('townPopulation').value = town.population || '';
        document.getElementById('townArea').value = town.area_km2 || '';
        document.getElementById('townType').value = town.town_type || '';
        document.getElementById('townLatitude').value = town.latitude || '';
        document.getElementById('townLongitude').value = town.longitude || '';
        
        document.getElementById('editTownForm').dataset.townId = townId;
        document.getElementById('editTownModal').classList.add('show');
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }
    
    // Event Listeners
    document.getElementById('addTownBtn').addEventListener('click', () => {
        document.getElementById('addTownModal').classList.add('show');
    });
    
    document.getElementById('editTownBtn').addEventListener('click', () => {
        if (selectedTownId) openEditModal(selectedTownId);
    });
    
    document.getElementById('deleteTownBtn').addEventListener('click', () => {
        const town = towns.find(t => t.id === selectedTownId);
        if (town) {
            document.getElementById('deleteTownName').textContent = town.name;
            document.getElementById('deleteConfirmModal').classList.add('show');
        }
    });
    
    document.getElementById('refreshBtn').addEventListener('click', loadTowns);
    
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const search = e.target.value.toLowerCase();
        document.querySelectorAll('.town-item').forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(search) ? '' : 'none';
        });
    });
    
    document.getElementById('countryFilter').addEventListener('change', (e) => {
        const country = e.target.value;
        document.querySelectorAll('.town-item').forEach(item => {
            const townId = parseInt(item.dataset.townId);
            const town = towns.find(t => t.id === townId);
            item.style.display = (!country || town.country === country) ? '' : 'none';
        });
    });
    
    // Modal close buttons
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.target.closest('.modal').classList.remove('show');
        });
    });
    
    // Form submission handlers
    document.getElementById('editTownForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const townId = e.target.dataset.townId;
        
        const data = {
            name: document.getElementById('townName').value,
            country: document.getElementById('townCountry').value,
            population: document.getElementById('townPopulation').value || 0,
            area_km2: document.getElementById('townArea').value || null,
            town_type: document.getElementById('townType').value,
            latitude: document.getElementById('townLatitude').value,
            longitude: document.getElementById('townLongitude').value,
        };
        
        fetch(`/advanced-mapping/api/town/edit/${townId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showMessage('Town updated successfully', 'success', 'editTownMessages');
                closeModal('editTownModal');
                loadTowns();
            } else {
                showMessage(result.error || 'Error updating town', 'danger', 'editTownMessages');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error updating town', 'danger', 'editTownMessages');
        });
    });
    
    document.getElementById('addTownForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const data = {
            name: document.getElementById('newTownName').value,
            country: document.getElementById('newTownCountry').value,
            population: document.getElementById('newTownPopulation').value || 0,
            area_km2: document.getElementById('newTownArea').value || null,
            town_type: document.getElementById('newTownType').value,
            latitude: document.getElementById('newTownLatitude').value,
            longitude: document.getElementById('newTownLongitude').value,
        };
        
        fetch('/api/trails/towns/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showMessage('Town added successfully', 'success', 'addTownMessages');
                closeModal('addTownModal');
                document.getElementById('addTownForm').reset();
                loadTowns();
            } else {
                showMessage(result.error || 'Error adding town', 'danger', 'addTownMessages');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error adding town', 'danger', 'addTownMessages');
        });
    });
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
        if (selectedTownId) {
            fetch(`/advanced-mapping/api/town/edit/${selectedTownId}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showMessage('Town deleted successfully', 'success');
                    closeModal('deleteConfirmModal');
                    selectedTownId = null;
                    loadTowns();
                } else {
                    showMessage(result.error || 'Error deleting town', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Error deleting town', 'danger');
            });
        }
    });
    
    // Cancel buttons
    document.getElementById('cancelEditBtn').addEventListener('click', () => closeModal('editTownModal'));
    document.getElementById('cancelDeleteBtn').addEventListener('click', () => closeModal('deleteConfirmModal'));
    document.getElementById('cancelAddBtn').addEventListener('click', () => closeModal('addTownModal'));
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        loadTowns();
    });
</script>
{% endblock %}
