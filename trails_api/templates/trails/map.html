{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trails Map - Proximity Search</title>

  <!-- ‚úÖ CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="{% static 'trails_api/css/leaflet-search.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="{% static 'css/global-theme.css' %}">

  
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .navbar {
      flex-shrink: 0;
    }

    .quick-nav {
      flex-shrink: 0;
    }

    .main-container {
      display: flex;
      flex: 1;
      gap: 0;
      overflow: hidden;
    }

    .sidebar {
      width: 320px;
      background: #f8f9fa;
      border-right: 1px solid #dee2e6;
      overflow-y: auto;
      padding: 16px;
      box-shadow: 2px 0 4px rgba(0,0,0,0.1);
      z-index: 100;
    }

    .sidebar .card {
      margin-bottom: 12px;
      border: 1px solid #dee2e6;
    }

    .sidebar .card-header {
      background-color: #e9ecef;
      border-bottom: 1px solid #dee2e6;
      font-weight: 600;
      padding: 10px 12px;
    }

    .sidebar .card-body {
      padding: 12px;
    }

    #map-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    #map { 
      height: 100%;
      width: 100%; 
    }
    
    /* POI Marker Styles */
    .poi-marker {
      background: none;
      border: none;
    }
    
    .leaflet-popup-content {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    
    /* POI Control Panel */
    .poi-control {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 12px;
    }

    .sidebar h6 {
      font-size: 13px;
      font-weight: 600;
      color: #2c3e50;
      margin: 0 0 10px 0;
    }

    .sidebar h5 {
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, #2E8B57 0%, #1f5f3f 100%);
      padding: 10px 12px;
      margin: -12px -12px 10px -12px;
      border-radius: 4px 4px 0 0;
    }

    .sidebar h4 {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, #2E27F5 0%, #1d1ba3 100%);
      padding: 12px 12px;
      margin: 0 0 12px 0;
      border-radius: 4px;
    }

    .sidebar label {
      font-size: 12px;
      margin-bottom: 6px;
    }

    .sidebar input, .sidebar select {
      font-size: 12px;
    }

    .sidebar button {
      font-size: 12px;
      margin-top: 6px;
    }

    /* Scrollbar styling */
    .sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Results panel in map */
    #trail-results {
      max-width: 280px !important;
    }

    /* Search control positioning - force to topleft beside zoom */
    .leaflet-top.leaflet-left .leaflet-control-search {
      position: absolute !important;
      float: none !important;
      left: 50px !important;
      top: 10px !important;
      margin: 0 !important;
      right: auto !important;
    }

    .leaflet-control-search.search-exp {
      position: absolute !important;
      left: 50px !important;
      top: 10px !important;
      margin: 0 !important;
      right: auto !important;
    }

    footer {
      flex-shrink: 0;
      background: #f8f9fa;
      border-top: 1px solid #dee2e6;
      padding: 20px;
    }

    /* Add these styles to your existing CSS */
 
/* Custom Map Markers */
.custom-marker {
    background: transparent !important;
    border: none !important;
}
 
/* City Popup Styling */
.city-popup {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
 
.city-popup h6 {
    margin: 0 0 10px 0;
    color: #2c3e50;
    font-weight: 600;
}
 
.city-popup-info {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-bottom: 10px;
}
 
.city-popup-info span {
    font-size: 12px;
    color: #555;
}
 
.population {
    font-weight: 600;
    color: #007bff !important;
}
 
.coordinates {
    font-family: 'Courier New', monospace;
    color: #666 !important;
}
 
.popup-buttons {
    display: flex;
    gap: 5px;
    margin-top: 8px;
}
 
.popup-buttons .btn {
    font-size: 11px;
    padding: 3px 8px;
}
 
/* City Info Panel */
.city-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin: 15px 0;
}
 
.info-item {
    border-left: 3px solid var(--primary-color);
    padding-left: 10px;
}
 
.info-item label {
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    font-weight: 600;
    margin: 0;
}
 
.info-item .value {
    font-size: 14px;
    color: #333;
    font-weight: 500;
    margin-top: 2px;
}
 
/* Loading state */
.loading {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
 
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* filepath: static/css/style.css */
/* Proximity Search Styles */
/* Numbered marker styling */
.numbered-marker {
    background-color: #198754;      /* Bootstrap green */
    color: white;
    font-weight: bold;
    border-radius: 50%;
    text-align: center;
    line-height: 32px;
    width: 32px;
    height: 32px;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }
  .marker-number {
    font-size: 14px;
  }
  
.proximity-results-panel {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 350px;
    max-height: 80vh;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}
 
.result-item {
    padding: 10px;
    border: 1px solid #ddd;
    margin-bottom: 5px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s;
}
 
.result-item:hover {
    background-color: #f8f9fa;
}
 
.proximity-result {
    min-width: 250px;
}
 
.proximity-result h6 {
    margin-bottom: 10px;
    color: #007bff;
    font-weight: 600;
}
 
.proximity-result p {
    margin-bottom: 5px;
    font-size: 13px;
}
 
/* Map cursor when in proximity mode */
.leaflet-container.proximity-mode {
    cursor: crosshair !important;
}
 
/* Responsive adjustments */
@media (max-width: 768px) {
    .proximity-results-panel {
        width: 90%;
        right: 5%;
        top: 10px;
    }
}
        .proximity-controls {
            position: fixed; /* use fixed so it's positioned relative to viewport and not clipped */
            top: 160px; /* lowered further so card sits well below navbar and left controls */
            left: 50px;
            z-index: 9999 !important; /* very high so card appears above navbar and overlays */
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            min-width: 250px;
        }
       
        .results-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 320px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: none;
        }
 
        .search-mode-selector {
            margin-bottom: 10px;
        }
 
        .search-controls {
            display: none;
            margin-top: 10px;
        }
 
        .radius-circle {
            opacity: 0.3;
        }
 
        .result-marker {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            font-size: 12px;
        }
 
        .search-marker {
            background: #dc3545;
            color: white;
            z-index: 1000;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 3px solid white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
        }
 
        .list-group-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
 
        .list-group-item:hover {
            background-color: #f8f9fa;
        }
 
        .distance-badge {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            color: #495057;
        }

        /*Force spacing*/
        .bi {
            margin-right: 0.4rem;
            vertical-align: middle;
          }
          
/* Responsive tweak for proximity-controls on small screens */
@media (max-width: 768px) {
    .proximity-controls {
        position: fixed;
        top: 68px; /* keep it below the mobile navbar */
        left: auto;
        right: 8px;
        width: 92%;
        max-width: 420px;
    }
}

/* Unified controls block: make the search input and radius card look like a single stacked block */

.leaflet-control-search.search-exp,
.proximity-controls {
    position: fixed !important; /* fixed so both follow viewport */
    left: 50px; /* align to left */
    transform: none;
    width: 340px; /* slightly wider */
    z-index: 9999 !important;
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.12);
    border: 1px solid rgba(0,0,0,0.08);
    padding: 6px;
    box-sizing: border-box;
}

.leaflet-control-search.search-exp {
    top: 120px !important; /* search sits above (moved down slightly) */
}

.leaflet-control-search.search-exp .search-input,
.leaflet-control-search.search-exp input[type="text"],
.leaflet-control-search.search-exp input[type="search"] {
    width: 100%;
    box-sizing: border-box;
    border-radius: 6px;
    padding: 6px 8px;
    border: 1px solid rgba(0,0,0,0.12);
}

.proximity-controls {
    top: 340px !important; /* increased gap below search */
    padding: 12px 14px;
}

@media (max-width: 768px) {
    .leaflet-control-search.search-exp,
    .proximity-controls {
        left: auto;
        transform: none;
        right: 8px;
        width: 92%;
        max-width: 420px;
    }
    .leaflet-control-search.search-exp { top: 68px !important; }
    .proximity-controls { top: calc(68px + 44px + 8px) !important; }
}

/* High Contrast Mode Styles */
body.high-contrast-mode #map-container {
    filter: contrast(1.2) saturate(1.3);
}

body.high-contrast-mode .navbar {
    background-color: #1a1a2e !important;
    border-bottom: 3px solid #00d4ff !important;
}

body.high-contrast-mode .sidebar {
    background-color: #0f3460 !important;
    color: #FFFFFF !important;
    border-right: 3px solid #00d4ff !important;
}

body.high-contrast-mode .card {
    background-color: #16213e !important;
    border: 2px solid #00d4ff !important;
    color: #FFFFFF !important;
}

body.high-contrast-mode .card-header {
    background-color: #0f3460 !important;
    border-bottom: 2px solid #00d4ff !important;
    color: #00d4ff !important;
    font-weight: bold !important;
}

body.high-contrast-mode .card-body {
    background-color: #16213e !important;
    color: #FFFFFF !important;
}

body.high-contrast-mode .btn {
    background-color: #00d4ff !important;
    color: #000000 !important;
    border: 2px solid #00d4ff !important;
    font-weight: bold !important;
}

body.high-contrast-mode .btn:hover {
    background-color: #00ff88 !important;
    color: #000000 !important;
    border-color: #00ff88 !important;
}

body.high-contrast-mode label {
    color: #FFFFFF !important;
    font-weight: 600 !important;
}

body.high-contrast-mode input,
body.high-contrast-mode select,
body.high-contrast-mode textarea {
    background-color: #0f3460 !important;
    color: #FFFFFF !important;
    border: 2px solid #00d4ff !important;
}

body.high-contrast-mode .alert {
    background-color: #16213e !important;
    border: 2px solid #00d4ff !important;
    color: #FFFFFF !important;
}

body.high-contrast-mode .leaflet-control {
    border: 2px solid #00d4ff !important;
}

body.high-contrast-mode .leaflet-control-search {
    border: 2px solid #00d4ff !important;
}

body.high-contrast-mode .text-muted {
    color: #CCCCCC !important;
}

body.high-contrast-mode footer {
    background-color: #0f3460 !important;
    border-top: 3px solid #00d4ff !important;
    color: #FFFFFF !important;
}

        

  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span class="navbar-brand">ü•æ Irish Trails Map</span>
        <a class="top-back" href="/" onclick="if (history.length>1){ history.back(); return false; }">
          ‚Üê Back
        </a>
      </div>
    </div>
  </nav>

  <!-- Quick Navigation -->
  <div class="quick-nav" style="display:flex;gap:12px;flex-wrap:wrap;margin:12px;padding:0 12px;">
    <a href="/" style="padding:12px 18px;background:var(--brand-primary,#2E8B57);color:#fff;border-radius:8px;text-decoration:none;">üè† Home</a>
    <a href="/dashboard/" style="padding:12px 18px;background:#8B4513;color:#fff;border-radius:8px;text-decoration:none;">üìä Dashboard</a>
    <a href="{% url 'advanced_js_mapping:map' %}" style="padding:12px 18px;background:#2E27F5;color:#fff;border-radius:8px;text-decoration:none;">üó∫Ô∏è Interactive Map</a>
    <a href="{% url 'advanced_js_mapping:index' %}" style="padding:12px 18px;background:#F5273F;color:#fff;border-radius:8px;text-decoration:none;">üè® Accommodations</a>
    <a href="{% url 'advanced_js_mapping:analytics' %}" style="padding:12px 18px;background:#FFB86B;color:#111;border-radius:8px;text-decoration:none;">üìà Analytics</a>
    <a href="/admin/" style="padding:12px 18px;background:#34495E;color:#fff;border-radius:8px;text-decoration:none;">‚öôÔ∏è Admin</a>
  </div>

  <!-- ‚úÖ Map Container with Sidebar -->
  <div class="main-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
      <h5 style="margin-bottom: 16px; color: #2c3e50;">üó∫Ô∏è Search & Explore</h5>

       <!-- High Contrast Mode Toggle -->
      <div class="card">
        <div class="card-header">‚ôø Accessibility</div>
        <div class="card-body">
          <button id="high-contrast-toggle" class="btn btn-warning btn-sm w-100" aria-pressed="false">
            üé® Toggle High Contrast
          </button>
          <small class="text-muted d-block mt-2">Improves visibility with enhanced colors and borders.</small>
        </div>
      </div>

      <!-- Trails within radius -->
      <div class="card">
        <div class="card-header">üìç Trails within radius</div>
        <div class="card-body">
          <input id="radius-input" type="number" class="form-control form-control-sm mb-2" value="50" min="1" max="500" placeholder="Radius (m)"/>
          <button id="toggle-search" class="btn btn-success btn-sm w-100">Enable Search</button>
          <small class="text-muted d-block mt-2">Select a trail marker to see details. Select a town marker for weather.</small>
        </div>
      </div>

      <!-- Points of Interest -->
      <div class="card">
        <div class="card-header">üìç Points of Interest</div>
        <div class="card-body" id="poi-controls">
          <div id="poi-checkboxes"></div>
          <button id="load-all-pois-btn" class="btn btn-sm btn-success w-100 mt-2">Load All POIs</button>
        </div>
      </div>

      <!-- Spatial Analysis -->
      <div class="card">
        <div class="card-header">üìä Spatial Analysis</div>
        <div class="card-body">
          <button id="analysis-btn" class="btn btn-sm btn-success w-100">Generate Report</button>
          <div id="analysis-results" style="font-size: 11px; margin-top: 8px;"></div>
        </div>
      </div>

      <!-- Rivers Info -->
      <div class="card">
        <div class="card-header">üåä Rivers</div>
        <div class="card-body">     
          <p style="font-size: 12px;">
            2,758 rivers across Ireland. Click any river to:
          </p>
          <ul style="font-size: 11px; margin: 8px 0;">
            <li>Show trails crossing</li>
            <li>Show nearby trails (10km)</li>
          </ul>
          <button id="load-rivers-btn" class="btn btn-success w-100">
            Load Rivers
          </button>
          <button id="clear-rivers-btn" class="btn btn-secondary w-100 mt-2" style="display:none;">
            Clear Rivers
          </button>
        </div>
      </div>

      <!-- Legend -->
      <div class="card">
        <div class="card-header">üé® Legend</div>
        <div class="card-body" style="font-size: 11px;">
          <div style="margin-bottom: 8px;">
            <span style="display: inline-block; width: 20px; height: 3px; background: #FF8C00; margin-right: 8px;"></span>
            <strong>Trail</strong>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="display: inline-block; width: 20px; height: 3px; background: #1e90ff; margin-right: 8px;"></span>
            <strong>River</strong>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="display: inline-block; width: 12px; height: 12px; background: #FF0000; border-radius: 50%; margin-right: 8px;"></span>
            <strong>Crossing Trail</strong>
          </div>
          <div>
            <span style="display: inline-block; width: 12px; height: 12px; background: #FFCC00; border: 2px solid #FF9F1C; border-radius: 50%; margin-right: 8px;"></span>
            <strong>Nearby Trail</strong>
          </div>
           <div>
            <span style="display: inline-block; width: 12px; height: 12px; background: #497db1ff; border: 2px solid #636e80ff; border-radius: 50%; margin-right: 8px;"></span>
            <strong>Town and Weather Details</strong>
          </div>
          <div>
            <span style="display: inline-block; width: 12px; height: 12px; background: #38de40ff; border: 2px solid #0a7041ff; border-radius: 50%; margin-right: 8px;"></span>
            <strong>Trail Details</strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Map Container -->
    <div id="map-container">
      <div id="map"></div>

      <!-- Results panel (stays on map) -->
      <div id="trail-results"
           class="position-absolute bottom-0 start-0 bg-white p-2 m-3 rounded shadow"
           style="z-index:1000; max-height: 40vh; overflow-y: auto; display: none;">
        <button class="btn btn-sm btn-close" onclick="document.getElementById('trail-results').style.display='none';" style="position: absolute; top: 5px; right: 5px;"></button>
        <small class="text-muted">Search results will appear here</small>
      </div>
    </div>
  </div>
  
<!-- ‚úÖ JavaScript order -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="{% static 'trails_api/js/leaflet-search.min.js' %}"></script>

<!-- ‚úÖ Main map logic must come last) -->
<script src="{% static 'trails_api/js/trails_map.js' %}"></script>

<!-- ‚úÖ POI and Boundary visualization -->
<script src="{% static 'trails_api/js/pois_boundaries.js' %}"></script>

<!-- Footer -->
<footer class="bg-light text-center py-4">
  <img src="{% static 'images/logo.png' %}" alt="Stay and Trek Logo" style="height: 60px; margin-bottom: 10px;">
  <p class="mb-0">&copy; Stay and Trek Hiking 2025</p>
</footer>



<script>
  /**
   * High Contrast Mode Toggle
   * Improves accessibility for users with visual impairments
   */
  function initializeHighContrastMode() {
    const toggle = document.getElementById('high-contrast-toggle');
    
    if (!toggle) {
      console.warn('High contrast toggle button not found');
      return;
    }

    // Load saved preference from localStorage
    const savedPreference = localStorage.getItem('highContrastMode');
    if (savedPreference === 'true') {
      enableHighContrast();
    }

    // Toggle button click handler
    toggle.addEventListener('click', () => {
      const isEnabled = document.body.classList.contains('high-contrast-mode');
      
      if (isEnabled) {
        disableHighContrast();
      } else {
        enableHighContrast();
      }
    });
  }

  function enableHighContrast() {
    document.body.classList.add('high-contrast-mode');
    localStorage.setItem('highContrastMode', 'true');
    
    const toggle = document.getElementById('high-contrast-toggle');
    if (toggle) {
      toggle.setAttribute('aria-pressed', 'true');
      toggle.textContent = 'üé® High Contrast: ON';
    }

    // Announce to screen readers
    announceToScreenReader('High contrast mode enabled');
    
    console.log('‚úÖ High contrast mode enabled');
  }

  function disableHighContrast() {
    document.body.classList.remove('high-contrast-mode');
    localStorage.setItem('highContrastMode', 'false');
    
    const toggle = document.getElementById('high-contrast-toggle');
    if (toggle) {
      toggle.setAttribute('aria-pressed', 'false');
      toggle.textContent = 'üé® Toggle High Contrast';
    }

    // Announce to screen readers
    announceToScreenReader('High contrast mode disabled');
    
    console.log('‚úÖ High contrast mode disabled');
  }

  function announceToScreenReader(message) {
    const announcement = document.createElement('div');
    announcement.setAttribute('role', 'status');
    announcement.setAttribute('aria-live', 'polite');
    announcement.setAttribute('aria-atomic', 'true');
    announcement.textContent = message;
    announcement.style.position = 'absolute';
    announcement.style.left = '-9999px';
    announcement.style.top = '-9999px';
    document.body.appendChild(announcement);
    
    // Remove after announcement is read
    setTimeout(() => announcement.remove(), 2000);
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', initializeHighContrastMode);
</script>

</body>
</html>
