{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trails Map - Proximity Search</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <style>
    #map { height: calc(100vh - 56px); width: 100%; }
  </style>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-success">
  <div class="container">
    <a class="navbar-brand" href="#">ü•æ Irish Trails Map</a>
  </div>
</nav>

<div id="map"></div>

<div id="trail-results"
     class="position-absolute bottom-0 start-0 bg-white p-2 m-3 rounded shadow"
     style="z-index:1000; width: 250px; max-height: 40vh; overflow-y: auto;">
  <small class="text-muted">Results will appear here after you click the map</small>
</div>

<div class="position-absolute top-0 end-0 p-3" style="z-index:1000;">
  <div class="card p-2">
    <h6>üîç Trails within radius</h6>
    <input id="radius-input" type="number" class="form-control form-control-sm mb-2"
           value="50" min="1" max="500" />
    <button id="toggle-search" class="btn btn-success btn-sm w-100">Enable Search</button>
  </div>
</div>

<!-- ‚úÖ Load Leaflet FIRST -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- ‚úÖ Then your inline map and proximity code -->
<script>
  const map = L.map('map').setView([53.35, -6.26], 7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  // Function to load and display trails
  async function loadTrails() {
    try {
      const response = await fetch('/api/trails/geojson/');
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      const data = await response.json();

      if (!data.features?.length) {
        console.warn("‚ö†Ô∏è No trail features returned from API");
        return;
      }

      const trailsLayer = L.geoJSON(data, {
        pointToLayer: (feature, latlng) =>
          L.circleMarker(latlng, {
            radius: 7,
            fillColor: '#28a745',
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.9
          }),
        onEachFeature: (feature, layer) => {
          const p = feature.properties;
          layer.bindPopup(`
            <div><strong>${p.trail_name}</strong><br>
            County: ${p.county}<br>
            Distance: ${p.distance_km} km<br>
            Difficulty: ${p.difficulty || 'N/A'}</div>
          `);
        }
      }).addTo(map);

      const bounds = trailsLayer.getBounds();
      if (bounds.isValid()) map.fitBounds(bounds);

      console.log(`‚úÖ Loaded ${data.features.length} trails successfully`);
    } catch (err) {
      console.error("‚ùå Error loading trails:", err);
    }
  }

  loadTrails();

  let searchEnabled = false, searchMarker, radiusCircle;
  const trailMarkers = [];

  document.getElementById('toggle-search').addEventListener('click', () => {
    searchEnabled = !searchEnabled;
    const btn = document.getElementById('toggle-search');
    btn.textContent = searchEnabled ? 'Click on map to search' : 'Enable Search';
    btn.className = searchEnabled ? 'btn btn-danger btn-sm w-100' : 'btn btn-success btn-sm w-100';
    if (!searchEnabled) clearSearch();
  });

  map.on('click', async (e) => {
    if (!searchEnabled) return;
    const radius = parseFloat(document.getElementById('radius-input').value) || 50;
    const { lat, lng } = e.latlng;
    clearSearch();

    searchMarker = L.marker([lat, lng]).addTo(map).bindPopup('Search center').openPopup();
    radiusCircle = L.circle([lat, lng], {radius: radius * 1000, color: 'green', fillOpacity: 0.1}).addTo(map);

    const res = await fetch('/api/trails/within-radius/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ latitude: lat, longitude: lng, radius_km: radius })
    });

    if (!res.ok) return alert('Error fetching trails');
    const data = await res.json();

    const resultsDiv = document.getElementById('trail-results');
    resultsDiv.innerHTML = `<h6>${data.total_found} trail(s) found within ${radius} km:</h6>`;

    data.nearest_trails.forEach(trail => {
      const { latitude, longitude } = trail;
      const marker = L.marker([latitude, longitude])
        .addTo(map)
        .bindPopup(`<b>${trail.name}</b><br>${trail.county}<br>${trail.distance_km} km`);
      trailMarkers.push(marker);

      const item = document.createElement('div');
      item.classList.add('border', 'rounded', 'p-1', 'mb-1');
      item.innerHTML = `<b>${trail.name}</b> (${trail.county}) ‚Äî ${trail.distance_km} km`;
      item.addEventListener('click', () => {
        map.setView([latitude, longitude], 11);
        marker.openPopup();
      });
      resultsDiv.appendChild(item);
    });

    if (trailMarkers.length) {
      map.fitBounds(L.featureGroup(trailMarkers).getBounds().pad(0.2));
    }
  });

  function clearSearch() {
    if (searchMarker) map.removeLayer(searchMarker);
    if (radiusCircle) map.removeLayer(radiusCircle);
    trailMarkers.forEach(m => map.removeLayer(m));
    trailMarkers.length = 0;
  }
</script>

<!-- ‚úÖ Optional: keep this last only if needed -->
<script src="{% static 'trails_api/js/trails_map.js' %}"></script>

</body>
</html>
